#!@PYTHON@

# cpupower-gui.in
#
# Copyright 2019-2020 Evangelos Rigas
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

import os
import sys
import signal
import gettext
import argparse


VERSION = "@VERSION@"
pkgdatadir = "@pkgdatadir@"
localedir = "@localedir@"

sys.path.insert(1, pkgdatadir)

from cpupower_gui.config import CpuPowerConfig
from cpupower_gui.helper import (
    apply_cpu_profile,
    apply_configuration,
    apply_balanced,
    apply_performance,
)

signal.signal(signal.SIGINT, signal.SIG_DFL)
gettext.install("cpupower-gui", localedir)

# Add argparse options
parser = argparse.ArgumentParser(
    prog="cpupower-gui",
    description="cpupower-gui - Set the scaling frequencies and governor of a CPU",
    formatter_class=argparse.RawDescriptionHelpFormatter,
)

parser.add_argument(
    "--version", action="version", version="%(prog)s {}".format(VERSION)
)

cmd_group = parser.add_mutually_exclusive_group()

cmd_group.add_argument(
    "-l",
    "--list-profiles",
    action="store_true",
    help="List available cpupower profiles",
)

cmd_group.add_argument(
    "--apply-config", action="store_true", help="Apply cpupower configuration",
)

cmd_group.add_argument(
    "--apply-profile", type=str, metavar="PROFILE", help="Apply a cpupower profile",
)

parser.add_argument(
    "-b", "--balanced", action="store_true", help="Change governor to balanced",
)
parser.add_argument(
    "-p", "--performance", action="store_true", help="Change governor to performance",
)

parser.add_argument(
    "--gapplication-service", action="store_true", help="Start gui from gapplication",
)

if __name__ == "__main__":
    args = parser.parse_args()
    conf = CpuPowerConfig()

    if args.balanced:
        apply_balanced()
        sys.exit(0)

    if args.performance:
        apply_performance()
        sys.exit(0)

    if args.list_profiles:  # List profiles
        profiles = conf.profiles
        if profiles:
            print("The available profiles are:")
            for prof in profiles:
                print("\t- {}".format(prof))
            sys.exit(0)

        print("No profiles were found!")
        sys.exit(0)

    if args.apply_profile:
        prof = args.apply_profile
        if prof in conf.profiles:
            print("Applying profile: ", prof)
            apply_cpu_profile(conf.get_profile(prof))
            sys.exit(0)
        else:
            print("Profile not found!")
            sys.exit(1)

    if args.apply_config:
        print("Applying configuration... ")
        apply_configuration(conf)
        sys.exit(0)

    import gi

    from gi.repository import Gio

    resource = Gio.Resource.load(os.path.join(pkgdatadir, "cpupower-gui.gresource"))
    resource._register()

    from cpupower_gui import main

    sys.exit(main.main(VERSION))


# vim:set filetype=python shiftwidth=4 softtabstop=4 expandtab:
